#!/bin/sh
#
#	configure - configure script for Yadex
#	AYM 2002-09-15
#

# This file is copyright André Majorel 2002-2005.
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of version 2 of the GNU General Public License as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 59 Temple
# Place, Suite 330, Boston, MA 02111-1307, USA.


set -e

APPNAME=yadex
VERSION=`cat VERSION`

AWK=awk
CC=
CFLAGS=-O
CXX=
CXXFLAGS=-O
HAVE_GETTIMEOFDAY=
HAVE_INTTYPES=
HAVE_NANOSLEEP=
HAVE_SNPRINTF=
HAVE_USLEEP=
INTERFACE=x11			# "bgi" or "x11" (only "x11" is maintained)
INTTYPES=
LDFLAGS=
PLATFORM=unix			# "dos" or "unix" (only "unix" is maintained)
PREFIX=/usr/local
X11INC=				# If set, need to compile with -I$(X11INC)
X11LIB=				# If set, need to link with -L$(X11LIB)

tmpdir="$TMPDIR"
[ -n "$tmpdir" ] || tmpdir=/tmp
cbasename=${APPNAME}_$$.c
cxxbasename=${APPNAME}_$$.cc
obasename=${APPNAME}_$$.o
ebasename=${APPNAME}_$$
cout=${APPNAME}_$$.out
cerr=${APPNAME}_$$.err


#
#	check - perform a test (given C code compiles and links)
#
check () {
  printf '%s' "$3" >"$tmpdir/$cbasename"
  printf 'checking %s...' "$1"
  if (cd "$tmpdir"
     "$CC" $CFLAGS -o $obasename -c $cbasename
     "$CC" $LDFLAGS -o $ebasename $obasename) >"$tmpdir/$cout" 2>&1
  then
    echo " yes"
    eval "$2=1"
    return 0
  else
    echo " no"
    sed 's/^/> /' "$tmpdir/$cout"
    eval "$2="
    return 1
  fi
}


#
#	checkxx - perform a test (given C++ code compiles)
#
checkxx () {
  printf '%s' "$3" >"$tmpdir/$cbasename"
  printf 'checking %s...' "$1"
  if (cd "$tmpdir" && "$CXX" $CXXFLAGS -c $cbasename >$cout 2>&1)
  then
    echo " yes"
    eval "$2=1"
    return 0
  else
    echo " no"
    sed 's/^/> /' "$tmpdir/$cout"
    eval "$2="
    return 1
  fi
}


#
#	genc - generate config.cc
#
genc () {
  pathname=$BUILDDIR/config.cc
  echo generating $pathname
  (
    set -e
    echo '// DO NOT EDIT -- generated by ./configure'
    echo
    echo '#include "config.h"'
    echo
    echo 'extern const char *yadex_etc_path[] ='
    echo '{'
    sed 's/\\/\\\\/g; s/"/\\"/g; s/^.*/  "&",/;' $BUILDDIR/config.etc
    echo '  0'
    echo '};'
    echo
    echo 'extern const char *yadex_share_path[] ='
    echo '{'
    sed 's/\\/\\\\/g; s/"/\\"/g; s/^.*/  "&",/;' $BUILDDIR/config.share
    echo '  0'
    echo '};'
  ) >$pathname
}


#
#	genbool - generate a boolean macro definition
#
genbool () {
  name=$1
  if [ -n "`eval echo \\$HAVE_$name`" ]; then
    echo "#define Y_$name"
  else
    echo "//#define Y_$name"
  fi
}


#
#	genh - generate config.h
#
genh () {
  pathname=$BUILDDIR/config.h
  echo generating $pathname
  (
    set -e
    echo '// DO NOT EDIT -- generated by ./configure'
    echo
    case "$PLATFORM" in
      dos)
	echo '#define Y_DOS'
	echo '//#define Y_UNIX';;
      unix)
	echo '//#define Y_DOS'
	echo '#define Y_UNIX';;
      *)
	echo "configure: bad \$PLATFORM \"$PLATFORM\"" >&2
	exit 1;;
    esac
    case "$INTERFACE" in
      bgi)
	echo '#define Y_BGI'
	echo '//#define Y_X11';;
      x11)
	echo '//#define Y_BGI'
	echo '#define Y_X11';;
      *)
	echo "configure: bad \$INTERFACE \"$INTERFACE\"" >&2
	exit 1;;
    esac
    genbool GETTIMEOFDAY
    genbool INTTYPES
    genbool NANOSLEEP
    genbool SNPRINTF
    genbool USLEEP
    [ -z "$INTTYPES" ] || printf '\n%s\n' "$INTTYPES"
    echo
    echo 'extern const char *yadex_etc_path[];'
    echo 'extern const char *yadex_share_path[];'
  ) >$pathname
}


#
#	fatal - abort with an error message to stderr
#
fatal ()
{
  printf 'configure: %s\n' "$@" >&2
  exit 1
}


#
#	Parse the command line
#
while [ "$#" -ge 1 ]
do
  case "$1" in
    --help)
      cat <<EOF
Usage:
  configure --help
  configure [--prefix path]
	    [--cc string] [--cflags string]
	    [--cxx string] [--cxxflags string]
	    [--x-includes path] [--x-libraries path]
	    [--ldflags strings]
EOF
      exit 0
      ;;

    --cc)
      shift
      [ "$#" -ge 1 ] || fatal "--cc requires an argument"
      CC="$1"
      ;;

    --cc=*)
      CC=`expr "x$1" : 'x--cc=\(.*\)'`
      ;;

    --cflags)
      shift
      [ "$#" -ge 1 ] || fatal "--cflags requires an argument"
      CFLAGS="$1"
      ;;

    --cflags=*)
      CFLAGS=`expr "x$1" : 'x--cflags=\(.*\)'`
      ;;

    --cxx)
      shift
      [ "$#" -ge 1 ] || fatal "--cxx requires an argument"
      CXX="$1"
      ;;

    --cxx=*)
      CXX=`expr "x$1" : 'x--cxx=\(.*\)'`
      ;;

    --cxxflags)
      shift
      [ "$#" -ge 1 ] || fatal "--cxxflags requires an argument"
      CXXFLAGS="$1"
      ;;

    --cxxflags=*)
      CXXFLAGS=`expr "x$1" : 'x--cxxflags=\(.*\)'`
      ;;

    --ldflags)
      shift
      [ "$#" -ge 1 ] || fatal "--ldflags requires an argument"
      LDFLAGS="$1"
      ;;

    --ldflags=*)
      LDFLAGS=`expr "x$1" : 'x--ldflags=\(.*\)'`
      ;;

    --prefix)
      shift
      [ "$#" -ge 1 ] || fatal "--prefix requires an argument"
      PREFIX="$1"
      ;;

    --prefix=*)
      PREFIX=`expr "x$1" : 'x--prefix=\(.*\)'`
      ;;

    --x-includes)
      shift
      [ "$#" -ge 1 ] || fatal "--x-includes requires an argument"
      X11INC="$1"
      ;;

    --x-includes=*)
      X11INC=`expr "x$1" : 'x--x-includes=\(.*\)'`
      ;;

    --x-libraries)
      shift
      [ "$#" -ge 1 ] || fatal "--x-libraries requires an argument"
      X11LIB="$1"
      ;;

    --x-libraries=*)
      X11LIB=`expr "x$1" : 'x--x-libraries=\(.*\)'`
      ;;

    -*)
      echo "configure: bad argument \"$1\"" 1>&2
      exit 1
      ;;

    *)
      echo "configure: too many arguments" 1>&2
      exit 1
  esac
  shift
done

#
#	Sanity checks
#
if expr "x$PREFIX" : x/ >/dev/null
then
  true
else
  echo "configure: --prefix: argument is not an absolute path" 1>&2
  exit 1
fi

# Solaris /bin/grep doesn't know about -Fx.
GREP=/usr/xpg4/bin/grep
[ -x $GREP ] || GREP=grep

#
#	Look for a C compiler
#
#	We try "gcc" first as commercial Unixen often have a bundled
#	"cc" command that's useless for our purposes (antiquated KNR
#	compiler or front-end that just hangs waiting for an answer from
#	some licence manager).
#
printf "looking for a C compiler..."
if [ -n "$CC" ]
then
  printf ' using user-supplied value:'
else
  CC=gcc
  if type $CC >/dev/null 2>&1
  then
    CFLAGS="$CFLAGS -Wall"
  else
    CC=c89
    if type $CC >/dev/null 2>&1
    then
      :
    else
      CC=cc
      if type $CC >/dev/null 2>&1
      then
	:
      else
	echo " none"
	echo "error: none of (gcc, c89, cc) work, is your PATH set right?" 1>&2
	exit 1
      fi
    fi
  fi
fi
echo " $CC"

#
#	does the C compiler actually work ?
#
printf "checking whether the C compiler works..."
(
  cd "$tmpdir"
  echo 'main (int argc, char *argv[]) { return 0; }' >$cbasename
  if ("$CC" $CFLAGS -o $obasename -c $cbasename
      "$CC" $LDFLAGS -o $ebasename $obasename
      ./$ebasename) >$cout 2>&1
  then
    echo " yes"
  else
    echo " no"
    sed 's/^/> /' $cout
    echo "error: looks like the C compiler is not working" 1>&2
    exit 1
  fi
)

#
#	Do we have gettimeofday() ?
#
check "for gettimeofday" HAVE_GETTIMEOFDAY '
#include <sys/time.h>
#include <time.h>
int main (int argc, char *argv[])
{
  struct timeval tv;
  struct timezone tz;
  int n = gettimeofday (&tv, &tz);
  return n;
}
' || true

#
#	Do we have nanosleep() ?
#
check "for nanosleep" HAVE_NANOSLEEP '
#include <time.h>
int main (int argc, char *argv[])
{
  struct timespec ts;
  ts.tv_sec = 1;
  ts.tv_nsec = 1;
  nanosleep (&ts, &ts);
  return 0;
}
' || true

#
#	Do we have snprintf() ?
#
check "for snprintf" HAVE_SNPRINTF '
#include <stdio.h>
int main (int argc, char *argv[])
{
  char buf[1];
  int n = snprintf (buf, sizeof buf, "%d", 42);
  return n;
}
' || true

#
#	Do we have usleep() ?
#
check "for usleep" HAVE_USLEEP '
#include <unistd.h>
int main (int argc, char *argv[])
{
  unsigned long usec = 1;
  usleep (usec);
  return 0;
}
' || true

#
#	Look for a C++ compiler
#
#	We try "g++" first, then "c++", then "cxx".
#
printf "looking for a C++ compiler..."
if [ -n "$CXX" ]
then
  printf ' using user-supplied value:'
else
  CXX=g++
  if type $CXX >/dev/null 2>&1
  then
    CXXFLAGS="$CXXFLAGS -Wall"
  else
    CXX=c++
    if type $CXX >/dev/null 2>&1
    then
      :
    else
      CXX=cxx
      if type $CXX >/dev/null 2>&1
      then
	:
      else
	echo " none"
	echo "error: none of (g++, c++, cxx) work, is your PATH set right?" 1>&2
	exit 1
      fi
    fi
  fi
fi
echo " $CXX"

#
#	Does the C++ compiler actually work ?
#
printf "checking whether the C++ compiler works..."
(
  cd "$tmpdir"
  echo 'main (int argc, char *argv[]) { return 0; }' >$cbasename
  if ("$CXX" $CXXFLAGS -o $obasename -c $cbasename
      "$CXX" $LDFLAGS -o $ebasename $obasename
      ./$ebasename) >$cout 2>&1
  then
    echo " yes"
  else
    echo " no"
    sed 's/^/> /' $cout
    echo "error: looks like the C++ compiler is not working" 1>&2
    exit 1
  fi
)

#
#	Do we have inttypes.h ?
#
printf 'checking for inttypes.h...'
if
(
  cd "$tmpdir"
  cat <<\EOF >$cxxbasename
#include <inttypes.h>
#include <stdio.h>

#define CHECKSIZE(type, size)						\
do									\
{									\
  printf ("%s %u\n", #type, (unsigned) sizeof (type));			\
  if (sizeof (type) != (size))						\
  {									\
    fflush (stdout);							\
    fprintf (stderr, "inttypes: size of %s is %u, expected %u\n",	\
      #type, (unsigned) sizeof (type), (unsigned) (size));		\
    status = 1;								\
  }									\
}									\
while (0)

int main (int argc, char *argv[])
{
  int status = 0;

  CHECKSIZE (int8_t,   1);
  CHECKSIZE (int16_t,  2);
  CHECKSIZE (int32_t,  4);
  CHECKSIZE (uint8_t,  1);
  CHECKSIZE (uint16_t, 2);
  CHECKSIZE (uint32_t, 4);
  return status;
}
EOF
  "$CXX" $CXXFLAGS -o $obasename -c $cxxbasename
  "$CXX" $LDFLAGS -o $ebasename $obasename
  ./$ebasename >$cout 2>&1
)
then
  echo " yes"
  HAVE_INTTYPES=1
else
  echo " no"
fi

#
#	If we don't have <inttypes.h>, make our own definitions for
#	{int,uint}{8,16,32}_t
#
if [ -z "$HAVE_INTTYPES" ]
then
  printf 'guessing at appropriate types for {int,uint}{8,16,32}_t...'
  if
  (
    cd "$tmpdir"
    cat <<\EOF >$cxxbasename
#include <assert.h>
#include <stdio.h>

int main (int argc, char *argv[])
{
  assert (sizeof (signed char) == 1);
  puts ("typedef signed char    int8_t;");
  assert (sizeof (short) == 2);
  puts ("typedef signed short   int16_t;");
  if (sizeof (long) == 4)
    puts ("typedef long           int32_t;");
  else if (sizeof (int) == 4)
    puts ("typedef int            int32_t;");
  else
    fprintf (stderr,
      "no 32-bit signed type (sizeof (long) = %u, sizeof (int) = %u)\n",
      (unsigned) sizeof (long), (unsigned) sizeof (int));

  assert (sizeof (unsigned char) == 1);
  puts ("typedef unsigned char  uint8_t;");
  assert (sizeof (unsigned short) == 2);
  puts ("typedef signed short   uint16_t;");
  if (sizeof (unsigned long) == 4)
    puts ("typedef unsigned long  uint32_t;");
  else if (sizeof (unsigned int) == 4)
    puts ("typedef unsigned int   uint32_t;");
  else
    fprintf (stderr,
      "no 32-bit unsigned type (sizeof (unsigned long) = %u, sizeof (unsigned)"
      " = %u)\n",
      (unsigned) sizeof (unsigned long), (unsigned) sizeof (unsigned int));
  return 0;
}
EOF
    "$CXX" $CXXFLAGS -o $obasename -c $cxxbasename
    "$CXX" $LDFLAGS -o $ebasename $obasename
    ./$ebasename >$cout 2>$cerr
  )
  then
    echo " success"
    INTTYPES=`cat "$tmpdir/$cout"`
  else
    echo " failure"
    cat "$tmpdir/$cerr"
    echo 'Report this bug to the maintainer!'
    exit 1
  fi
fi

#
#	Locate the X headers
#
printf "checking for the X11 headers..."
if [ -n "$X11INC" ]
then
  echo " using user-supplied value: $X11INC"
else
  cat <<\EOF >"$tmpdir/$cbasename"
#include <X11/Xlib.h>
int main (int argc, char *argv[])
{
  return XOpenDisplay (0) == 0 ? 0 : 1;
}
EOF
  if (cd "$tmpdir"; "$CC" $CFLAGS -o $obasename -c $cbasename >$cout 2>&1)
  then
    echo " yes"
    X11INC=
  else
    # List lifted from GNU autoconf
    for dir in				\
      /usr/include			\
      /usr/X11/include			\
      /usr/X11R6/include		\
      /usr/X11R5/include		\
      /usr/X11R4/include		\
					\
      /usr/include/X11			\
      /usr/include/X11R6		\
      /usr/include/X11R5		\
      /usr/include/X11R4		\
					\
      /usr/local/X11/include		\
      /usr/local/X11R6/include		\
      /usr/local/X11R5/include		\
      /usr/local/X11R4/include		\
					\
      /usr/local/include/X11		\
      /usr/local/include/X11R6		\
      /usr/local/include/X11R5		\
      /usr/local/include/X11R4		\
					\
      /usr/X386/include			\
      /usr/x386/include			\
      /usr/XFree86/include/X11		\
					\
      /usr/include			\
      /usr/local/include		\
      /usr/unsupported/include		\
      /usr/athena/include		\
      /usr/local/x11r5/include		\
      /usr/lpp/Xamples/include		\
					\
      /usr/openwin/include		\
      /usr/openwin/share/include	\
      ;
    do
      [ -f "$dir/X11/Xlib.h" ] || continue
      echo " yes (in $dir)"
      X11INC="$dir"
      break;
    done
    if [ -z "$X11INC" ]
    then
      echo " no"
      fatal "X11 headers not found, install them or supply --x-includes"
    fi
  fi
fi

#
#	Locate the X libraries
#
printf "checking for the X11 libraries..."
if [ -n "$X11LIB" ]
then
  echo " using user-supplied value: $X11LIB"
else
  cat <<\EOF >"$tmpdir/$cbasename"
#include <X11/Xlib.h>
int main (int argc, char *argv[])
{
  return XOpenDisplay (0) == 0 ? 0 : 1;
}
EOF
  o=
  [ -z "$X11INC" ] || o="-I$X11INC"
  if (cd "$tmpdir"
      "$CC" $CFLAGS $o -o $obasename -c $cbasename
      "$CC" $LDFLAGS -o $ebasename $obasename) >"$tmpdir/$cout" 2>&1
  then
    echo " yes"
    X11LIB=
  else
    # List lifted from GNU autoconf
    for dir in			\
      /usr/X11/lib		\
      /usr/X11R6/lib		\
      /usr/X11R5/lib		\
      /usr/X11R4/lib		\
				\
      /usr/lib/X11		\
      /usr/lib/X11R6		\
      /usr/lib/X11R5		\
      /usr/lib/X11R4		\
				\
      /usr/local/X11/lib	\
      /usr/local/X11R6/lib	\
      /usr/local/X11R5/lib	\
      /usr/local/X11R4/lib	\
				\
      /usr/local/lib/X11	\
      /usr/local/lib/X11R6	\
      /usr/local/lib/X11R5	\
      /usr/local/lib/X11R4	\
				\
      /usr/X386/lib		\
      /usr/x386/lib		\
      /usr/XFree86/lib/X11	\
				\
      /usr/lib			\
      /usr/local/lib		\
      /usr/unsupported/lib	\
      /usr/athena/lib		\
      /usr/local/x11r5/lib	\
      /usr/lpp/Xamples/lib	\
      /lib/usr/lib/X11		\
				\
      /usr/openwin/lib		\
      /usr/openwin/share/lib	\
      ;
    do
      [ -f "$dir/libX11.a"  ] ||
      [ -f "$dir/libX11.so" ] ||
      [ -f "$dir/libX11.sl" ] || continue
      echo " yes (in $dir)"
      X11LIB="$dir"
      break;
    done
    if [ -z "$X11LIB" ]
    then
      echo " no"
      fatal "X11 libraries not found, install them or supply --x-libraries"
    fi
  fi
fi

#
#	Locate a POSIX-compatible awk(1)
#
printf "checking for a standard-compliant awk..."
if (cd "$tmpdir"
    echo a | $AWK '{ print sub(/^a/, "b") $0 }' >$cout 2>&1
    [ "x`cat $tmpdir/$cout`" = "x1b" ])
then
  echo " yes"
else
  AWK=/usr/xpg4/bin/awk
  if (cd "$tmpdir"
      echo a | $AWK '{ print sub(/^a/, "b") $0 }' >$cout 2>&1
      [ "x`cat $tmpdir/$cout`" = "x1b" ])
  then
    echo " yes ($AWK)"
  else
    echo " no"
    fatal "no suitable awk found, is your PATH set right?"
  fi
fi

#
#	Create the directory where the build-specific files go
#
SYSTEM_RAW=`uname -n`_`uname -a | cksum`
SYSTEM=`echo "$SYSTEM_RAW" | tr -dc '[:alnum:]._-'`
BUILDDIR=obj/$SYSTEM
echo "build directory is $BUILDDIR"
mkdir -p $BUILDDIR

#
#	FHS paths
#
if expr "$PREFIX" : '//*usr/*$' >/dev/null
then
  BINDIR=/usr/bin		# FHS-ly correct is /usr/games
  ETCDIR=/etc/$APPNAME/%v
  ETCDIRNV=/etc/$APPNAME
  MANDIR=/usr/share/man
  SHAREDIR=/usr/share/games/$APPNAME/%v
  SHAREDIRNV=/usr/share/games/$APPNAME
elif expr "$PREFIX" : '//*usr//*local/*$' >/dev/null
then
  BINDIR=/usr/local/bin		# FHS-ly correct is /usr/local/games
  ETCDIR=/etc/$APPNAME/%v
  ETCDIRNV=/etc/$APPNAME
  MANDIR=/usr/local/man
  SHAREDIR=/usr/local/share/games/$APPNAME/%v
  SHAREDIRNV=/usr/local/share/games/$APPNAME
elif expr "$PREFIX" : '//*opt/*$' >/dev/null
then
  echo '/opt ? Surely you mean /opt/something, Mr. Feynman !' 1>&2
  exit 1
elif expr "$PREFIX" : '//*opt//*[^/]' >/dev/null
then
  BINDIR=$PREFIX/bin
  ETCDIR=/etc/opt/`expr "$PREFIX" : '//*opt//*\(.*\)'`
  ETCDIRNV=
  MANDIR=$PREFIX/man
  SHAREDIR=$PREFIX/share
  SHAREDIRNV=
else					# Probably /home/joe/*
  BINDIR=$PREFIX/bin
  ETCDIR=$PREFIX/etc
  ETCDIRNV=
  MANDIR=$PREFIX/man
  SHAREDIR=$PREFIX/share
  SHAREDIRNV=
fi

#
#	Write Makefile.config
#
echo generating $BUILDDIR/Makefile.config
(
  echo "# DO NOT EDIT -- generated by ./configure"
  echo
  echo "AWK               = $AWK"
  echo "BINDIR            = $BINDIR"
  echo "CC                = $CC"
  echo "CFLAGS            = $CFLAGS"
  echo "CXX               = $CXX"
  echo "CXXFLAGS          = $CXXFLAGS"
  echo "ETCDIR            = $ETCDIR" | sed "s/%v/$VERSION/g"
  echo "ETCDIRNV          = $ETCDIRNV"
  echo "HAVE_GETTIMEOFDAY = $HAVE_GETTIMEOFDAY"
  echo "HAVE_INTTYPES     = $HAVE_INTTYPES"
  echo "HAVE_NANOSLEEP    = $HAVE_NANOSLEEP"
  echo "HAVE_SNPRINTF     = $HAVE_SNPRINTF"
  echo "HAVE_USLEEP       = $HAVE_USLEEP"
  echo "INTERFACE         = $INTERFACE"
  echo "LDFLAGS           = $LDFLAGS"
  echo "MANDIR            = $MANDIR"
  echo "PLATFORM          = $PLATFORM"
  echo "SHAREDIR          = $SHAREDIR" | sed "s/%v/$VERSION/g"
  echo "SHAREDIRNV        = $SHAREDIRNV"
  echo "X11INC            = $X11INC"
  echo "X11LIB            = $X11LIB"
) >$BUILDDIR/Makefile.config

#
#	YGD files search path
#
echo generating $BUILDDIR/config.share
$GREP -Fvx '' <<EOF >"$BUILDDIR/config.share"
.
~/.$APPNAME/%v
~/.$APPNAME
$SHAREDIR
$SHAREDIRNV
EOF

#
#	Config files search path
#
echo generating $BUILDDIR/config.etc
$GREP -Fvx '' <<EOF >"$BUILDDIR/config.etc"
.
~/.$APPNAME/%v
~/.$APPNAME
$ETCDIR
$ETCDIRNV
EOF

#
#	Write config.h and config.cc
#
genc 
genh

exit 0
